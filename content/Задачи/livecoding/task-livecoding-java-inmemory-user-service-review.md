#### 81. Code Review: In-memory UserService: –∫–æ–¥-—Ä–µ–≤—å—é –∏ –ø—Ä–∞–≤–∫–∏

üî• –ù—É–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ø–∞–º—è—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–∑ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤ –∏ –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤. –†–∞–∑–±–µ—Ä—ë–º –ø—Ä–æ–±–ª–µ–º—ã –∏ —É–ª—É—á—à–∏–º –∫–æ–¥ –¥–ª—è –ø—Ä–æ–¥–æ–≤–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫–æ–π.

```java
@Service
public class UserService {
    private Map<Integer, User> usersCache = new HashMap<>();

    public void addUser(User user) {
        usersCache.put(user.getId(), user);
    }

    public User getUser(int id) {
        return usersCache.get(id);
    }

    public List<User> getAllUsers() {
        return new ArrayList<>(usersCache.values());
    }
}
```

---

{{< hint warning >}}  
**–°–ø–æ–π–ª–µ—Ä—ã –∫ —Ä–µ—à–µ–Ω–∏—é**  
{{< /hint >}}

{{< details "–ü–æ–¥—Å–∫–∞–∑–∫–∏" close >}}  
üí° –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: `HashMap` –Ω–µ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–µ–Ω ‚Äî –≤–æ–∑—å–º–∏ `ConcurrentHashMap`.  
üí° –ö–æ–Ω—Ç—Ä–∞–∫—Ç—ã –º–µ—Ç–æ–¥–æ–≤: –≤–∞–ª–∏–¥–∞—Ü–∏—è `user`/`id`, –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –¥—É–±–ª–∏–∫–∞—Ç–µ (id —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç).  
üí° –ò–º–º—É—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å: –µ—Å–ª–∏ `User` –∏–∑–º–µ–Ω—è–µ–º—ã–π, –ª—É—á—à–µ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∫–æ–ø–∏–∏/DTO, —á—Ç–æ–±—ã –Ω–µ –ª–æ–º–∞—Ç—å –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã.  
üí° –í–æ–∑–≤—Ä–∞—Ç—ã: –¥–ª—è —á—Ç–µ–Ω–∏—è ‚Äî `Optional<User>` –≤–º–µ—Å—Ç–æ `null`, –¥–ª—è –ø—É—Å—Ç—ã—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–π ‚Äî `List.of()`.  
üí° API –ø–æ–ª–Ω–æ—Ç–∞: —á–∞—Å—Ç–æ –Ω—É–∂–Ω—ã `create/update/delete`, `exists`, `count`.  
üí° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –≤–æ–∑–≤—Ä–∞—â–∞–π –Ω–µ–∏–∑–º–µ–Ω—è–µ–º—É—é –∫–æ–ø–∏—é —Å–ø–∏—Å–∫–∞ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –∞–ª–ª–æ–∫–∞—Ü–∏–π.  
{{< /details >}}

{{< details "–†–µ—à–µ–Ω–∏–µ" close >}}

```java
@Service
public class UserService {

    // –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ, —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
    private final ConcurrentMap<Integer, User> users = new ConcurrentHashMap<>();

    /**
     * –°–æ–∑–¥–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ë—Ä–æ—Å–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –µ—Å–ª–∏ id —É–∂–µ –∑–∞–Ω—è—Ç.
     */
    public User create(User user) {
        validateUser(user);
        User prev = users.putIfAbsent(user.getId(), user);
        if (prev != null) {
            throw new IllegalStateException("User with id=" + user.getId() + " already exists");
        }
        return user;
    }

    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç –∏–ª–∏ —Å–æ–∑–¥–∞—ë—Ç (upsert) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
     */
    public User upsert(User user) {
        validateUser(user);
        users.put(user.getId(), user);
        return user;
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ id.
     */
    public Optional<User> get(int id) {
        return Optional.ofNullable(users.get(id));
    }

    /**
     * –£–¥–∞–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ id. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç true, –µ—Å–ª–∏ —É–¥–∞–ª—ë–Ω.
     */
    public boolean delete(int id) {
        return users.remove(id) != null;
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–∏–∑–º–µ–Ω—è–µ–º—ã–π —Å–Ω–∏–º–æ–∫ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
     * –í–∞–∂–Ω–æ: —ç–ª–µ–º–µ–Ω—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å –∏–∑–º–µ–Ω—è–µ–º—ã–º–∏, –ø—Ä–æ–¥—É–º–∞–π –∏–º–º—É—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å User.
     */
    public List<User> getAll() {
        // –ë—ã—Å—Ç—Ä—ã–π —Å–Ω–∏–º–æ–∫ –±–µ–∑ –ª–∏—à–Ω–∏—Ö –∫–æ–ø–∏–π –∑–Ω–∞—á–µ–Ω–∏–π
        return List.copyOf(users.values());
    }

    public boolean exists(int id) {
        return users.containsKey(id);
    }

    public int count() {
        return users.size();
    }

    private static void validateUser(User user) {
        if (user == null) throw new IllegalArgumentException("user must not be null");
        if (user.getId() == null) throw new IllegalArgumentException("user.id must not be null");
    }
}
```

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∫ —É–ª—É—á—à–µ–Ω–∏—è–º:

- –ï—Å–ª–∏ `User` –∏–∑–º–µ–Ω—è–µ–º—ã–π (–º—É—Ç–∞–±–µ–ª—å–Ω—ã–π), —Ä–∞—Å—Å–º–æ—Ç—Ä–∏ –≤–∞—Ä–∏–∞–Ω—Ç: —Ö—Ä–∞–Ω–∏—Ç—å **–∏–º–º—É—Ç–∞–±–µ–ª—å–Ω—ã–µ** –∫–æ–ø–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `record UserDto(...)`) –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∏—Ö –Ω–∞—Ä—É–∂—É, —á—Ç–æ–±—ã –≤–Ω–µ—à–Ω–∏–π –∫–æ–¥ –Ω–µ –º–µ–Ω—è–ª —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫—ç—à–∞ ¬´–º–∏–º–æ¬ª —Å–µ—Ä–≤–∏—Å–∞.
- –î–ª—è –≥–æ—Ä—è—á–µ–≥–æ —Ä–µ—Å—Ç–∞—Ä—Ç–∞/–æ—Ç–ª–∞–¥–∫–∏ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥—ã **—ç–∫—Å–ø–æ—Ä—Ç–∞/–∏–º–ø–æ—Ä—Ç–∞** (JSON —Å–Ω–∞–ø—à–æ—Ç) –∏–ª–∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –¥–∞–º–ø –Ω–∞ –¥–∏—Å–∫.
- –ï—Å–ª–∏ id –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–∏—Å–∞, –¥–æ–±–∞–≤—å `AtomicInteger/Long` –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏ `create` –±–µ–∑ id.
- –ï—Å–ª–∏ –Ω—É–∂–Ω–æ TTL –∏–ª–∏ –ª–∏–º–∏—Ç –ø–∞–º—è—Ç–∏ ‚Äî –ø–æ–≤–µ—Ä—Ö `ConcurrentHashMap` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Caffeine (`Cache`) —Å –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏ –∏—Å—Ç–µ—á–µ–Ω–∏—è/–≤—ã—Ç–∞–ª–∫–∏–≤–∞–Ω–∏—è.


{{< /details >}}