#### 79. Code Review: –ú–µ—Ç–æ–¥ find –≤ —Å–µ—Ä–≤–∏—Å–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–∞

üî• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ö–æ–¥–∏—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—á–∫—É –º–∞–≥–∞–∑–∏–Ω–∞, –≤—ã–±–∏—Ä–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤. –§–∏–ª—å—Ç—Ä–æ–≤ –±–æ–ª—å—à–µ 5. –ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª —Ñ–∏–ª—å—Ç—Ä—ã –∏ –Ω–∞–∂–∞–ª –ù–∞–π—Ç–∏, –∫ –Ω–∞–º –Ω–∞ –±—ç–∫ –ø–æ—Å—Ç—É–ø–∞–µ—Ç –∑–∞–ø—Ä–æ—Å, –∏ –ø—Ä–∏–ª–µ—Ç–∞–µ—Ç –≤ —ç—Ç–æ—Ç —É—á–∞—Å—Ç–æ–∫ –∫–æ–¥–∞, –≤ –º–µ—Ç–æ–¥ find(Filter filter). –ú—ã –∏—â–µ–º –∫–æ–ª-–≤–æ —Ç–æ–≤–∞—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—Ç —Ñ–∏–ª—å—Ç—Ä—É. –ï—Å–ª–∏ –∏—Ö –±–æ–ª—å—à–µ 0, —Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã, –∏–Ω–∞—á–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫. –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è 200 —Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É. –í 50 –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö —Å–ª—É—á–∞–µ–≤ count = 0

```java
class Service {
    //200 RPS
    //50% count = 0
    
    public List<Product> find(Filter filter) {
        int count = repo.count(filter);
        if(count > 0) {
            return repo.find(filter);
        }
        return new ArrayList<>();
    }
}
```

---

{{< hint warning >}}  
**–°–ø–æ–π–ª–µ—Ä—ã –∫ —Ä–µ—à–µ–Ω–∏—é**  
{{< /hint >}}

{{< details "–ü–æ–¥—Å–∫–∞–∑–∫–∏" close >}}  
üí° –î–≤–æ–π–Ω–æ–π –∑–∞–ø—Ä–æ—Å –∫ –ë–î (`count` + `find`) –Ω–∞–≥—Ä—É–∂–∞–µ—Ç —Å–∏—Å—Ç–µ–º—É. –õ—É—á—à–µ —Å–¥–µ–ª–∞—Ç—å –æ–¥–∏–Ω.  
üí° –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å —Å–ø–∏—Å–æ–∫, –ø—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–π `repo.find(filter)` –∏ –ø—Ä–æ–≤–µ—Ä—è–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ –ø—É—Å—Ç–æ—Ç—É.  
üí° –ü—Ä–∏ RPS=200 –∏ 50% –ø—É—Å—Ç—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î –≤–æ–∑—Ä–∞—Å—Ç–∞–µ—Ç √ó2.  
üí° –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Å –Ω—É–ª–µ–≤—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ 30 —Å–µ–∫—É–Ω–¥).  
üí° –ò—Å–ø–æ–ª—å–∑—É–π `Collections.emptyList()` –≤–º–µ—Å—Ç–æ `new ArrayList<>()`.  
üí° –î–ª—è —á–∞—Å—Ç–æ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏ in-memory –∫—ç—à –∏–ª–∏ Redis.  
üí° –ï—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –º–Ω–æ–≥–æ –∏ —Å–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –ø–æ–¥—É–º–∞–π –æ –¥–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ search-–¥–≤–∏–∂–∫–∞ (Elastic, Solr).  
{{< /details >}}

{{< details "–†–µ—à–µ–Ω–∏–µ" close >}}

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:

```java
class Service {
    public List<Product> find(Filter filter) {
        List<Product> products = repo.find(filter);
        return products.isEmpty() ? Collections.emptyList() : products;
    }
}
```

–í–∞—Ä–∏–∞–Ω—Ç —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø—É—Å—Ç—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:

```java
class Service {
    private final Cache<Filter, Boolean> emptyResultCache = Caffeine.newBuilder()
            .expireAfterWrite(Duration.ofSeconds(30))
            .build();

    public List<Product> find(Filter filter) {
        if (Boolean.TRUE.equals(emptyResultCache.getIfPresent(filter))) {
            return Collections.emptyList();
        }

        List<Product> products = repo.find(filter);

        if (products.isEmpty()) {
            emptyResultCache.put(filter, true);
            return Collections.emptyList();
        }

        return products;
    }
}
```

- –£–±—Ä–∞–Ω –ª–∏—à–Ω–∏–π `count`-–∑–∞–ø—Ä–æ—Å.
- –í–æ–∑–≤—Ä–∞—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `Collections.emptyList()`.
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞—Ç—å —á–∞—Å—Ç—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã —Å –ø—É—Å—Ç—ã–º–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏.


{{< /details >}}