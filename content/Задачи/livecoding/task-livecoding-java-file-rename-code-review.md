#### 105. –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ (–§–° + Postgres) –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

**–£—Å–ª–æ–≤–∏–µ –∑–∞–¥–∞—á–∏:**

```
–ï—Å—Ç—å —Å–∏—Å—Ç–µ–º–∞, –∫–æ—Ç–æ—Ä–∞—è –¥–∞–µ—Ç —é–∑–µ—Ä–∞–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ñ–∞–π–ª–∞–º–∏ –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –°—Ç–µ–∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π. Java, Spring, React, Postgres. –§–∞–π–ª—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ –Ω–∞ –±–µ–∫–µ. –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª–æ–≤ –≤ –ë–î. –ö–æ–º–∞–Ω–¥–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–ª–∞ —Ñ–∏—á—É - –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞. –ö –≤–∞–º –ø—Ä–∏—à–µ–ª —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–¥ –Ω–∞ —Ä–µ–≤—å—é. –í –∫–æ–º–∞–Ω–¥–µ –ø—Ä–∏–Ω—è—Ç–æ —Å–ª–µ–¥—É—é—â–µ–µ: –ù–∞ –∫–æ–¥ —Ä–µ–≤—å—é –ø—Ä–∏—Ö–æ–¥–∏—Ç –∫–æ–¥ —Å –∑–µ–ª–µ–Ω—ã–º –±–∏–ª–¥–æ–º, –ø–æ–¥–≤–æ—Ö–æ–≤ —Å –∫–æ–º–ø–∏–ª—è—Ü–∏–µ–π –Ω–µ—Ç. –ö–æ–¥ –±–∞–∑–æ–≤–æ –ø–æ–∫—Ä—ã—Ç –∞–≤—Ç–æ—Ç–µ—Å—Ç–∞–º–∏ —Å –ø–æ–¥–Ω—è—Ç–∏–µ–º –°–ø—Ä–∏–Ω–≥–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞. –ü–æ–¥–≤–æ—Ö–æ–≤ —Å–æ –°–ø—Ä–∏–Ω–≥ –ø—Ä–æ–∫—Å–∏ —Ç–æ–∂–µ –Ω–µ—Ç. –ü—Ä–æ–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —Ä–µ–≤—å—é
```


**–ö–æ–¥:**

```java
@Transactional
public void process(String oldName,
String newName) {
Long id = exec("select id from file
where name='" + oldName + "'"); //
–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î

processFile(oldName, newName); //
—Ñ–∞–π–ª–∞ –Ω–∞ –¥–∏—Å–∫–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
exec("update file set name=\"" +
newName + "\" where id = " + id); //
–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –∫ –ë–î
```

{{< hint warning >}}  
**–°–ø–æ–π–ª–µ—Ä—ã –∫ —Ä–µ—à–µ–Ω–∏—é**  
{{< /hint >}}

{{< details "–ü–æ–¥—Å–∫–∞–∑–∫–∏" close >}}  
üí° –ó–¥–µ—Å—å —Å–º–µ—à–∞–Ω—ã –¥–≤–µ ¬´—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏¬ª: –ë–î –∏ —Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞. –§–° –Ω–µ –æ—Ç–∫–∞—Ç–∏—Ç—Å—è –ø—Ä–∏ rollback –ë–î.  
üí° SQL-–∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏—è = SQL injection + –ø—Ä–æ–±–ª–µ–º—ã —Å –∫–∞–≤—ã—á–∫–∞–º–∏ + —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ.  
üí° `file` ‚Äî –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–ª–æ–≤–æ/–ø–ª–æ—Ö–æ–µ –∏–º—è —Ç–∞–±–ª–∏—Ü—ã.  
üí° –ü–æ–∏—Å–∫ –ø–æ `name` –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ ‚Üí –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ.  
üí° –ì–æ–Ω–∫–∏: –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ + –æ–ø–µ—Ä–∞—Ü–∏—è –§–° –º–µ–∂–¥—É –Ω–∏–º–∏ ‚Üí –≤–æ–∑–º–æ–∂–Ω—ã race conditions.  
üí° –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ `newName` (—É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å), –Ω–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–ª–ª–∏–∑–∏–π –Ω–∞ –§–°.  
üí° –ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–∞ (–ø—É—Å—Ç—ã–µ –∏–º–µ–Ω–∞, path traversal `../`).  
üí° –ù–µ—Ç ¬´–∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏¬ª: —á—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ —Ñ–∞–π–ª –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª—Å—è, –∞ update –Ω–µ –ø—Ä–æ—à—ë–ª (–∏–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç)?  
{{< /details >}}

{{< details "–†–µ—à–µ–Ω–∏–µ" close >}}

### –ß—Ç–æ –ø–ª–æ—Ö–æ –≤ —Ç–µ–∫—É—â–µ–º —Ä–µ—à–µ–Ω–∏–∏

1. **SQL Injection + –∫–∞–≤—ã—á–∫–∏**


```java
"where name='" + oldName + "'"
```

- –õ—é–±–æ–π `oldName` —Å `'` –ª–æ–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å.

- –ú–æ–∂–Ω–æ –∏–Ω–∂–µ–∫—Ç–∏—Ç—å SQL.


‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: —Ç–æ–ª—å–∫–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (PreparedStatement/JdbcTemplate/Repository).

2. **–ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –ë–î –∏ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã**


- `@Transactional` –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ë–î.

- –ï—Å–ª–∏ `processFile()` –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª —Ñ–∞–π–ª, –∞ `update` —É–ø–∞–ª ‚Üí –ë–î –æ—Ç–∫–∞—Ç–∏—Ç—Å—è, –∞ —Ñ–∞–π–ª –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–º.

- –ï—Å–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç: –ë–î –æ–±–Ω–æ–≤–∏–ª–∏, –∞ —Ñ–∞–π–ª –Ω–µ —Å–º–æ–≥–ª–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å ‚Üí –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤—Ä—É—Ç.


‚úÖ –ù—É–∂–Ω–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏:

- –ª–∏–±–æ **—Å–Ω–∞—á–∞–ª–∞** –ë–î + –∑–∞–ø–∏—Å—å ‚Äú–≤ –ø—Ä–æ—Ü–µ—Å—Å–µ‚Äù, –ø–æ—Ç–æ–º –§–°, –ø–æ—Ç–æ–º ‚Äú–≥–æ—Ç–æ–≤–æ‚Äù (saga/state machine),

- –ª–∏–±–æ outbox/–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥,

- –ª–∏–±–æ —Å—Ç—Ä–æ–≥–æ–µ –ø—Ä–∞–≤–∏–ª–æ: —Å–Ω–∞—á–∞–ª–∞ –§–°, –ø–æ—Ç–æ–º –ë–î, –∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ –§–° –¥–µ–ª–∞—Ç—å –∫–æ–º–ø–µ–Ω—Å–∏—Ä—É—é—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ (rename back).


3. **–ì–æ–Ω–∫–∏ –∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è**


- –ú–µ–∂–¥—É `select` –∏ `update` –º–æ–∂–µ—Ç –≤–º–µ—à–∞—Ç—å—Å—è –¥—Ä—É–≥–æ–π –ø–æ—Ç–æ–∫:

    - —Ñ–∞–π–ª —É–∂–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–ª–∏,

    - –∑–∞–ø–∏—Å—å –∏–∑–º–µ–Ω–∏–ª–∏,

    - –ø–æ—è–≤–∏–ª–æ—Å—å –¥—Ä—É–≥–æ–µ –∏–º—è.


‚úÖ –†–µ—à–µ–Ω–∏–µ:

- –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `SELECT ... FOR UPDATE` –ø–æ id,

- –∏–ª–∏ —Å—Ä–∞–∑—É `UPDATE ... WHERE name = ?` –∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫,

- –∏–ª–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –Ω–∞ `name` + –æ–±—Ä–∞–±–æ—Ç–∫–∞ `duplicate key`.


4. **–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏**


- –ò–º—è –Ω–µ –æ–±—è–∑–∞–Ω–æ –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º (–∏–ª–∏ –Ω–µ —Å–∫–∞–∑–∞–Ω–æ).

- `select id where name=...` –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫.


‚úÖ –í –º–æ–¥–µ–ª–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä: –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –ø–æ `fileId`, –∞ –Ω–µ –ø–æ –∏–º–µ–Ω–∏.

5. **–í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏–º–µ–Ω–∏**


- `newName` –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å `../`, `\0`, —Å–ª—ç—à–∏, —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã ‚Üí path traversal, –≤—ã—Ö–æ–¥ –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏.

- `oldName/newName` –º–æ–≥—É—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º–∏ –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–º–∏.


‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è:

- —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–π –Ω–∞–±–æ—Ä —Å–∏–º–≤–æ–ª–æ–≤,

- –∑–∞–ø—Ä–µ—Ç `..`, `/`, `\`,

- –¥–ª–∏–Ω–∞,

- –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è Unicode (–ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º).


6. **–ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–ª–ª–∏–∑–∏–π**


- `newName` —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:

    - –Ω–∞ –§–° (—Ñ–∞–π–ª —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º –µ—Å—Ç—å),

    - –≤ –ë–î (—É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ–±–µ—Å–ø–µ—á–µ–Ω–∞).


‚úÖ –†–µ—à–µ–Ω–∏–µ:

- —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –≤ –ë–î (–Ω–∞–ø—Ä–∏–º–µ—Ä, `(folder_id, name)`),

- –ø—Ä–æ–≤–µ—Ä–∫–∞/–æ–±—Ä–∞–±–æ—Ç–∫–∞ `FileAlreadyExistsException`.


---

### –ö–∞–∫ –±—ã —è –ø–µ—Ä–µ–ø–∏—Å–∞–ª (–∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–æ, –±–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ ORM)

**–ò–¥–µ—è: —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ `fileId`, –¥–µ—Ä–∂–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É –∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å.**

–ü—Å–µ–≤–¥–æ-–∫–æ–¥:

```java
@Transactional
public void rename(long fileId, String newName) {
    // 1) –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ –∑–∞–ø–∏—Å—å
    FileMeta meta = repository.findByIdForUpdate(fileId)
            .orElseThrow(...);

    String oldName = meta.getName();

    // 2) –≤–∞–ª–∏–¥–∞—Ü–∏—è
    validateName(newName);

    // 3) –æ–±–Ω–æ–≤–∏–ª–∏ –ë–î (–º–æ–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å RENAMING)
    meta.setName(newName);
    repository.save(meta);

    // 4) –ø–æ—Å–ª–µ –∫–æ–º–º–∏—Ç–∞ –¥–µ–ª–∞–µ–º –§–°-–æ–ø–µ—Ä–∞—Ü–∏—é
    // —á—Ç–æ–±—ã –Ω–µ –¥–µ—Ä–∂–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –ë–î –Ω–∞ –≤—Ä–µ–º—è IO
    TransactionSynchronizationManager.registerSynchronization(
        new TransactionSynchronizationAdapter() {
            @Override
            public void afterCommit() {
                try {
                    fileStorage.rename(oldName, newName); // atomic move –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö FS
                } catch (Exception ex) {
                    // –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è: –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å –Ω–∞ reconcile/rollback
                    // –Ω–∞–ø—Ä–∏–º–µ—Ä, outbox event "RENAME_FAILED"
                }
            }
        }
    );
}
```

**–ü–æ—è—Å–Ω–µ–Ω–∏–µ:**

- –í–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ë–î ‚Äî —Ç–æ–ª—å–∫–æ —Ä–∞–±–æ—Ç–∞ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ (–±—ã—Å—Ç—Ä–æ).

- IO (—Ñ–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞) ‚Äî –ø–æ—Å–ª–µ –∫–æ–º–º–∏—Ç–∞, —á—Ç–æ–±—ã –Ω–µ –¥–µ—Ä–∂–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –æ—Ç–∫—Ä—ã—Ç–æ–π.

- –ï—Å–ª–∏ rename –Ω–∞ –§–° —É–ø–∞–ª ‚Äî –Ω—É–∂–µ–Ω –º–µ—Ö–∞–Ω–∏–∑–º –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏–∏ (reconcile job / outbox / —Å—Ç–∞—Ç—É—Å ‚Äú–æ—à–∏–±–∫–∞‚Äù).


---

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å (–µ—Å–ª–∏ ‚Äú–±—ã—Å—Ç—Ä–æ –ø–æ—Ñ–∏–∫—Å–∏—Ç—å‚Äù)

- –ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞—Ç—å SQL.

- –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞—Ç—å –ø–æ `fileId`, –∞ –Ω–µ –ø–æ –∏–º–µ–Ω–∏.

- –°–¥–µ–ª–∞—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∏–º–µ–Ω–∏ (–æ–±—ã—á–Ω–æ –ø–æ –ø–∞–ø–∫–µ) –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î.

- –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é `newName`.

- –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∏ –∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—é (rename back / —Å—Ç–∞—Ç—É—Å).


---

### –°–∏–ª—å–Ω—ã–π ‚Äúproduction‚Äù –≤–∞—Ä–∏–∞–Ω—Ç

- –í –ë–î: –ø–æ–ª—è `status` (READY/RENAMING/ERROR), `updated_at`, —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å `(folder_id, name)`.

- –°–æ–±—ã—Ç–∏—è: outbox ‚ÄúFILE_RENAMED‚Äù / ‚ÄúFILE_RENAME_FAILED‚Äù.

- –§–æ–Ω–æ–≤–∞—è –¥–∂–æ–±–∞ reconcile: —Å–≤–µ—Ä—è–µ—Ç –ë–î –∏ –§–°, —á–∏–Ω–∏—Ç —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è.


{{< /details >}}