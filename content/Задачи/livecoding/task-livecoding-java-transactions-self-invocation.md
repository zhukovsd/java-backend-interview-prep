#### 97. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: —Å–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç –ø—Ä–∏ –≤—ã–∑–æ–≤–µ b() –∏ –∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å a() —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–º

**–£—Å–ª–æ–≤–∏–µ –∑–∞–¥–∞—á–∏:**  
üìå –î–∞–Ω –∫–æ–¥:

```java
@Service
class SomeService {

    @Transactional(propagation = Required_New)
    public void a() {}

    @Transactional
    public void b() {
        a();
    }
}

SomeService.b();
```

–ù—É–∂–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å:

1. –°–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—Ä–∏ –≤—ã–∑–æ–≤–µ `b()`?

2. –ü–æ—á–µ–º—É?

3. –ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å, —á—Ç–æ–±—ã –≤—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤ (`a()`) —Ç–æ–∂–µ –±—ã–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–º (`REQUIRES_NEW`)?


{{< hint warning >}}  
**–°–ø–æ–π–ª–µ—Ä—ã –∫ —Ä–µ—à–µ–Ω–∏—é**  
{{< /hint >}}

{{< details "–ü–æ–¥—Å–∫–∞–∑–∫–∏" close >}}  
üí° `@Transactional` —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ Spring AOP proxy.  
üí° –í—ã–∑–æ–≤ `a()` –≤–Ω—É—Ç—Ä–∏ `b()` ‚Äî —ç—Ç–æ **self-invocation** (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –≤—ã–∑–æ–≤ –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞), –æ–Ω –ø—Ä–æ—Ö–æ–¥–∏—Ç –º–∏–º–æ proxy.  
üí° –ü–æ—ç—Ç–æ–º—É `REQUIRES_NEW` –Ω–µ –ø—Ä–∏–º–µ–Ω–∏—Ç—Å—è, –µ—Å–ª–∏ `a()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –∫–∞–∫ `a()`.  
üí° –ù—É–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å `a()` —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏: –≤—ã–Ω–µ—Å—Ç–∏ `a()` –≤ –¥—Ä—É–≥–æ–π –±–∏–Ω –∏–ª–∏ –ø–æ–ª—É—á–∏—Ç—å self-proxy –∏ –≤—ã–∑–≤–∞—Ç—å —á–µ—Ä–µ–∑ –Ω–µ–≥–æ.  
{{< /details >}}

{{< details "–†–µ—à–µ–Ω–∏–µ" close >}}

**1) –°–∫–æ–ª—å–∫–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –±—É–¥–µ—Ç?**

–ë—É–¥–µ—Ç **1 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è** ‚Äî —Ç–∞, —á—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –º–µ—Ç–æ–¥–µ `b()`.

**2) –ü–æ—á–µ–º—É?**

- Spring –ø—Ä–∏–º–µ–Ω—è–µ—Ç `@Transactional` —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ (AOP).

- –í—ã–∑–æ–≤ `SomeService.b()` –∏–∑–≤–Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ ‚Üí —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–æ–∑–¥–∞—ë—Ç—Å—è.

- –ù–æ –≤–Ω—É—Ç—Ä–∏ `b()` –≤—ã–∑–æ–≤ `a()` –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∫–∞–∫ –æ–±—ã—á–Ω—ã–π –≤—ã–∑–æ–≤ –º–µ—Ç–æ–¥–∞ —Ç–µ–∫—É—â–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞ (`this.a()` —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏).

- –¢–∞–∫–æ–π –≤—ã–∑–æ–≤ **–Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏**, –ø–æ—ç—Ç–æ–º—É –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è –Ω–∞ `a()` **–Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç**, –∏ `REQUIRES_NEW` –Ω–µ —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é.


**3) –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å, —á—Ç–æ–±—ã `a()` —Ç–æ–∂–µ –±—ã–ª —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω—ã–º (REQUIRES_NEW)?**

**–°–ø–æ—Å–æ–± 1 (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏ —Å–∞–º—ã–π —á–∞—Å—Ç—ã–π): –≤—ã–Ω–µ—Å—Ç–∏ `a()` –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å.**

```java
@Service
class AService {
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void a() {}
}

@Service
@RequiredArgsConstructor
class SomeService {

    private final AService aService;

    @Transactional
    public void b() {
        aService.a(); // –≤—ã–∑–æ–≤ —á–µ—Ä–µ–∑ proxy –¥—Ä—É–≥–æ–≥–æ –±–∏–Ω–∞ ‚Üí REQUIRES_NEW —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
    }
}
```

**–°–ø–æ—Å–æ–± 2: –≤—ã–∑–≤–∞—Ç—å —á–µ—Ä–µ–∑ self-proxy (–º–µ–Ω–µ–µ –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ).**

```java
@Service
class SomeService {

    @Autowired
    private SomeService self; // –ø—Ä–æ–∫—Å–∏ —Å–∞–º–æ–≥–æ —Å–µ–±—è

    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void a() {}

    @Transactional
    public void b() {
        self.a(); // –≤—ã–∑–æ–≤ —á–µ—Ä–µ–∑ proxy ‚Üí —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
    }
}
```

> –í–∞–∂–Ω–æ: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∫–ª—é—á—ë–Ω proxy-mode –∏ –∏–Ω—ä–µ–∫—Ü–∏—è –±—É–¥–µ—Ç –∏–º–µ–Ω–Ω–æ –ø—Ä–æ–∫—Å–∏-–æ–±—ä–µ–∫—Ç–∞.

{{< /details >}}